<?xml version="1.0" encoding="UTF-8"?>

<odoo>

    <record id="snippet_css" model="ir.actions.server">
        <field name="name">Get Snippet CSS</field>
        <field name="condition">True</field>
        <field name="website_published" eval="True"/>
        <field name="website_path">website_snippet.css</field>
        <field name="model_id" ref="base.model_ir_actions_server"/>
        <field name="code">
snippets = request.env['x_website_snippet'].sudo().search([])

css = ""
for snippet in snippets:
    css += snippet.x_css or ''

response = request.make_response(css, {
    'Cache-Control': 'no-cache', 
    'Content-Type': 'text/css; charset=utf-8',
})
        </field>
        <field name="state">code</field>
        <field name="type">ir.actions.server</field>
    </record>

    <record id="snippet_js" model="ir.actions.server">
        <field name="name">Get Snippet JS</field>
        <field name="condition">True</field>
        <field name="website_published" eval="True"/>
        <field name="website_path">website_snippet.js</field>
        <field name="model_id" ref="base.model_ir_actions_server"/>
        <field name="code">
snippets = request.env['x_website_snippet'].sudo().search([])

base_js = """
%s
odoo.define('website_snippet.snippets', function(require) {
    "use strict";
    var snippets = []
    %s
    return snippets;
});
"""
defines = ""
for snippet in snippets:
    id = snippet.id
    js = snippet.x_js or ''
    name = snippet.x_name or 'Undefined'
    html = snippet.x_html or ''
    html = html.replace("\n", '')

    defines += """
odoo.define('website_snippet.snippet_%s', function(require) {
    "use strict";
    %s

    return {
        'id': %s,
        'name': '%s',
        'html': '%s',
    }
});
""" % (id, js, id, name, html)

requires = ""
for snippet in snippets:
    requires += """
    snippets['snippet_%s'] = require('website_snippet.snippet_%s');
""" % (snippet.id, snippet.id)

response = request.make_response(base_js % (defines, requires), {
    'Cache-Control': 'no-cache', 
    'Content-Type': 'text/javascript; charset=utf-8',
})
        </field>
        <field name="state">code</field>
        <field name="type">ir.actions.server</field>
    </record>

</odoo>